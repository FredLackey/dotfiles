# Implementation Plan: Multi-Environment Shell Scripts

This plan implements the requirements defined in [REQUIREMENTS.md](REQUIREMENTS.md). Follow each step in order.

---

## Overview

We will restructure the functions directory to support both bash and zsh by:
1. Creating shell-specific subdirectories (`bash/` and `zsh/`)
2. Moving existing functions to `bash/`
3. Creating zsh-compatible versions in `zsh/`
4. Adding shell config snippets that source the correct functions

**Current structure:**
```
src/os/macos/functions/
├── docker-clean.sh
├── ccurl.sh
└── ... (39 files total)
```

**Target structure:**
```
src/os/macos/functions/
├── bash/
│   ├── main.sh           # Sources all bash functions
│   ├── docker-clean.sh
│   ├── ccurl.sh
│   └── ...
├── zsh/
│   ├── main.sh           # Sources all zsh functions
│   ├── docker-clean.sh
│   ├── ccurl.sh
│   └── ...
└── README.md
```

---

## Step 1: Create Directory Structure

Create the new shell-specific directories.

```bash
mkdir -p src/os/macos/functions/bash
mkdir -p src/os/macos/functions/zsh
```

**Verify:** Both directories exist and are empty.

---

## Step 2: Move Existing Functions to bash/

All existing functions use bash syntax, so move them to the `bash/` subdirectory.

```bash
cd src/os/macos/functions
mv *.sh bash/
```

**Verify:**
- `ls bash/` shows all 39 function files
- `ls *.sh` in the functions directory returns "No such file" (no .sh files remain at root level)

---

## Step 3: Create zsh Versions

For each function in `bash/`, create a corresponding file in `zsh/`. Most functions will be identical—only those using bash-specific syntax need modification.

### 3.1: Copy All Functions

```bash
cp bash/*.sh zsh/
```

### 3.2: Update Shebangs in zsh/

Change all shebangs from `#!/bin/bash` to `#!/bin/zsh`:

```bash
cd zsh
for file in *.sh; do
    sed -i '' 's|#!/bin/bash|#!/bin/zsh|' "$file"
done
```

**Verify:** `head -1 zsh/*.sh` shows `#!/bin/zsh` for all files.

### 3.3: Fix Incompatible Syntax

The following files require syntax changes for zsh compatibility. This list was generated by scanning all 39 function files for bash-specific patterns.

---

#### 3.3.1: docker-clean.sh

**Location:** `src/os/macos/functions/zsh/docker-clean.sh`

**Issue:** `read -p` and `read -n` are bash-specific.

**Find this line (line 22):**
```bash
read -p "Are you sure you want to continue? (y/N): " -n 1 -r
```

**Replace with:**
```zsh
printf "Are you sure you want to continue? (y/N): "
read -k 1 -r REPLY
```

**Explanation:**
- `read -p "prompt"` does not exist in zsh (the `-p` flag means "read from coprocess")
- `read -n 1` does not exist in zsh (use `read -k 1` for single character)
- `printf` displays the prompt instead
- `-r` works the same in both shells (raw input, no backslash processing)

---

#### 3.3.2: evm.sh

**Location:** `src/os/macos/functions/zsh/evm.sh`

**Issue:** Bash-specific array slicing syntax.

**Find this line (line 19):**
```bash
local numberOfTimes="${*: -1}"
```

**Replace with:**
```zsh
local numberOfTimes="${@[-1]}"
```

**Explanation:**
- `${*: -1}` is bash syntax for "the last positional parameter"
- `${@[-1]}` is the zsh equivalent (negative index from end)

**Find this line (line 23):**
```bash
files=("${@:1:$#-1}")
```

**Replace with:**
```zsh
files=("${@[1,-2]}")
```

**Explanation:**
- `${@:1:$#-1}` is bash syntax for "all arguments except the last"
- `${@[1,-2]}` is the zsh equivalent (from index 1 to second-to-last)

---

#### 3.3.3: rename-files-with-date-in-name.sh

**Location:** `src/os/macos/functions/zsh/rename-files-with-date-in-name.sh`

**Issue:** Bash-specific positional parameter default syntax.

**Find this line (line 35):**
```bash
for filePath in "${@:-.}"; do
```

**Replace with:**
```zsh
for filePath in "${@:-.}"; do
```

**Wait—this syntax actually works in zsh.** Upon further testing, `${@:-.}` (positional parameters with default) is compatible with zsh. No change needed for this file.

**Status:** No changes required.

---

### 3.4: Files Analyzed - No Changes Required

The following files were analyzed and found to be **zsh-compatible** despite using features that sometimes differ between shells:

| File | Feature Used | Why It's Safe |
|------|--------------|---------------|
| `ips.sh` | `[[ "$var" =~ pattern ]]` | Regex matching works in zsh; no capture groups used |
| `rm-safe.sh` | `[[ "$var" =~ pattern ]]` | Regex matching works in zsh; no capture groups used |
| `evm.sh` | `[[ "$var" =~ pattern ]]` | Regex matching works in zsh; no capture groups used |
| `resize-image.sh` | `${2:-default}` | Parameter default syntax works in both shells |
| `delete-files.sh` | `${1:-default}` | Parameter default syntax works in both shells |
| `refresh-files.sh` | `${2:-default}` | Parameter default syntax works in both shells |
| `get-dependencies.sh` | `${2:-default}` | Parameter default syntax works in both shells |
| `install-dependencies-from.sh` | `${2:-default}` | Parameter default syntax works in both shells |

**Key distinction:**
- `${var:-default}` — Parameter expansion with default. **Works in both shells.**
- `${@:1:length}` — Array slicing. **Bash-only syntax.**

---

### 3.5: Summary of Required Changes

| File | Line(s) | Bash Syntax | Zsh Replacement |
|------|---------|-------------|-----------------|
| `docker-clean.sh` | 22 | `read -p "..." -n 1 -r` | `printf "..."; read -k 1 -r REPLY` |
| `evm.sh` | 19 | `${*: -1}` | `${@[-1]}` |
| `evm.sh` | 23 | `${@:1:$#-1}` | `${@[1,-2]}` |

**Total files requiring changes: 2 out of 39**

---

## Step 4: Create Main Loader Scripts

Create a `main.sh` in each shell directory that sources all functions via a static list.

### 4.1: Create bash/main.sh

**File:** `src/os/macos/functions/bash/main.sh`

```bash
#!/bin/bash
# Bash functions loader
# Usage (add to .bashrc):
#   source ~/.dotfiles/src/os/macos/functions/bash/main.sh

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

source "$SCRIPT_DIR/backup-all.sh"
source "$SCRIPT_DIR/backup-source.sh"
source "$SCRIPT_DIR/ccurl.sh"
source "$SCRIPT_DIR/claude-danger.sh"
source "$SCRIPT_DIR/clean-dev.sh"
source "$SCRIPT_DIR/clone.sh"
source "$SCRIPT_DIR/datauri.sh"
source "$SCRIPT_DIR/delete-files.sh"
source "$SCRIPT_DIR/docker-clean.sh"
source "$SCRIPT_DIR/dp.sh"
source "$SCRIPT_DIR/evm.sh"
source "$SCRIPT_DIR/fetch-github-repos.sh"
source "$SCRIPT_DIR/get-channel.sh"
source "$SCRIPT_DIR/get-course.sh"
source "$SCRIPT_DIR/get-dependencies.sh"
source "$SCRIPT_DIR/get-folder.sh"
source "$SCRIPT_DIR/get-tunes.sh"
source "$SCRIPT_DIR/get-video.sh"
source "$SCRIPT_DIR/git-backup.sh"
source "$SCRIPT_DIR/git-clone.sh"
source "$SCRIPT_DIR/git-pup.sh"
source "$SCRIPT_DIR/git-push.sh"
source "$SCRIPT_DIR/h.sh"
source "$SCRIPT_DIR/install-dependencies-from.sh"
source "$SCRIPT_DIR/ips.sh"
source "$SCRIPT_DIR/killni.sh"
source "$SCRIPT_DIR/mkd.sh"
source "$SCRIPT_DIR/ncu-update-all.sh"
source "$SCRIPT_DIR/npmi.sh"
source "$SCRIPT_DIR/org-by-date.sh"
source "$SCRIPT_DIR/refresh-files.sh"
source "$SCRIPT_DIR/remove-smaller-files.sh"
source "$SCRIPT_DIR/rename-files-with-date-in-name.sh"
source "$SCRIPT_DIR/resize-image.sh"
source "$SCRIPT_DIR/rm-safe.sh"
source "$SCRIPT_DIR/s.sh"
source "$SCRIPT_DIR/set-git-public.sh"
source "$SCRIPT_DIR/vpush.sh"
```

### 4.2: Create zsh/main.sh

**File:** `src/os/macos/functions/zsh/main.sh`

```zsh
#!/bin/zsh
# Zsh functions loader
# Usage (add to .zshrc):
#   source ~/.dotfiles/src/os/macos/functions/zsh/main.sh

SCRIPT_DIR="${0:A:h}"

source "$SCRIPT_DIR/backup-all.sh"
source "$SCRIPT_DIR/backup-source.sh"
source "$SCRIPT_DIR/ccurl.sh"
source "$SCRIPT_DIR/claude-danger.sh"
source "$SCRIPT_DIR/clean-dev.sh"
source "$SCRIPT_DIR/clone.sh"
source "$SCRIPT_DIR/datauri.sh"
source "$SCRIPT_DIR/delete-files.sh"
source "$SCRIPT_DIR/docker-clean.sh"
source "$SCRIPT_DIR/dp.sh"
source "$SCRIPT_DIR/evm.sh"
source "$SCRIPT_DIR/fetch-github-repos.sh"
source "$SCRIPT_DIR/get-channel.sh"
source "$SCRIPT_DIR/get-course.sh"
source "$SCRIPT_DIR/get-dependencies.sh"
source "$SCRIPT_DIR/get-folder.sh"
source "$SCRIPT_DIR/get-tunes.sh"
source "$SCRIPT_DIR/get-video.sh"
source "$SCRIPT_DIR/git-backup.sh"
source "$SCRIPT_DIR/git-clone.sh"
source "$SCRIPT_DIR/git-pup.sh"
source "$SCRIPT_DIR/git-push.sh"
source "$SCRIPT_DIR/h.sh"
source "$SCRIPT_DIR/install-dependencies-from.sh"
source "$SCRIPT_DIR/ips.sh"
source "$SCRIPT_DIR/killni.sh"
source "$SCRIPT_DIR/mkd.sh"
source "$SCRIPT_DIR/ncu-update-all.sh"
source "$SCRIPT_DIR/npmi.sh"
source "$SCRIPT_DIR/org-by-date.sh"
source "$SCRIPT_DIR/refresh-files.sh"
source "$SCRIPT_DIR/remove-smaller-files.sh"
source "$SCRIPT_DIR/rename-files-with-date-in-name.sh"
source "$SCRIPT_DIR/resize-image.sh"
source "$SCRIPT_DIR/rm-safe.sh"
source "$SCRIPT_DIR/s.sh"
source "$SCRIPT_DIR/set-git-public.sh"
source "$SCRIPT_DIR/vpush.sh"
```

**Notes:**

- Each shell uses its native syntax for getting the script directory
- Bash: `$(dirname "${BASH_SOURCE[0]}")`
- Zsh: `${0:A:h}` (absolute path, head/directory)
- When adding new functions, add a `source` line to both `main.sh` files

**Verify:** Both `bash/main.sh` and `zsh/main.sh` exist with identical function lists.

---

## Step 5: Create Documentation

Create a README in the functions directory explaining the structure.

**File:** `src/os/macos/functions/README.md`

```markdown
# Shell Functions

This directory contains shell functions organized by shell type.

## Structure

functions/
├── bash/
│   ├── main.sh    # Sources all bash functions
│   └── *.sh       # Individual function files
├── zsh/
│   ├── main.sh    # Sources all zsh functions
│   └── *.sh       # Individual function files
└── README.md

## Usage

Add the appropriate line to your shell configuration:

**For bash (~/.bashrc):**
source ~/.dotfiles/src/os/macos/functions/bash/main.sh

**For zsh (~/.zshrc):**
source ~/.dotfiles/src/os/macos/functions/zsh/main.sh

## Adding New Functions

1. Create the function in bash/ with #!/bin/bash shebang
2. Copy to zsh/ and change shebang to #!/bin/zsh
3. Fix any bash-specific syntax (see table below)
4. Add a source line to BOTH bash/main.sh and zsh/main.sh

### Syntax Differences

| Bash                    | Zsh                           |
|-------------------------|-------------------------------|
| read -p "prompt" var    | printf "prompt"; read var     |
| read -n 1               | read -k 1                     |
| ${*: -1}                | ${@[-1]}                      |
| ${@:1:$#-1}             | ${@[1,-2]}                    |
| ${arr[0]}               | ${arr[1]}                     |
| $BASH_REMATCH           | $MATCH / $match               |

## Testing

After adding or modifying functions:

1. Open a new terminal with the target shell
2. Verify the function loads: type function_name
3. Test the function works as expected
```

---

## Step 6: Verification Checklist

Run these checks to confirm the implementation is complete:

### Directory Structure

- [ ] `src/os/macos/functions/bash/` exists and contains all function files
- [ ] `src/os/macos/functions/zsh/` exists and contains all function files
- [ ] No `.sh` files remain directly in `src/os/macos/functions/` (only README.md)

### Shebangs

- [ ] All files in `bash/` have `#!/bin/bash` shebang
- [ ] All files in `zsh/` have `#!/bin/zsh` shebang

### Syntax Fixes (per Section 3.5)

- [ ] `zsh/docker-clean.sh` line 22: uses `printf` + `read -k 1 -r REPLY` instead of `read -p ... -n 1 -r`
- [ ] `zsh/evm.sh` line 19: uses `${@[-1]}` instead of `${*: -1}`
- [ ] `zsh/evm.sh` line 23: uses `${@[1,-2]}` instead of `${@:1:$#-1}`

### Loader Scripts

- [ ] `src/os/macos/functions/bash/main.sh` exists with static source list
- [ ] `src/os/macos/functions/zsh/main.sh` exists with static source list

### Documentation

- [ ] `src/os/macos/functions/README.md` exists and explains the structure

---

## Step 7: Testing in VM

Per repository rules, **do not test locally**. Push changes to GitHub and test in a pristine virtual machine.

### Test Matrix

| OS    | Shell | Test Steps                                                                 |
|-------|-------|----------------------------------------------------------------------------|
| macOS | bash  | 1. Clone repo 2. Add source line to `.bashrc` 3. Open new terminal 4. Run `type docker-clean` |
| macOS | zsh   | 1. Clone repo 2. Add source line to `.zshrc` 3. Open new terminal 4. Run `type docker-clean`  |

### Expected Results

- `type docker-clean` should show the function definition
- `docker-clean` should display the confirmation prompt correctly
- Pressing `y` or `n` should work without needing to press Enter (single character read)

---

## Files Changed Summary

| Action | Path                                                              |
|--------|-------------------------------------------------------------------|
| Create | `src/os/macos/functions/bash/` (directory)                        |
| Create | `src/os/macos/functions/zsh/` (directory)                         |
| Move   | `src/os/macos/functions/*.sh` → `src/os/macos/functions/bash/`    |
| Create | `src/os/macos/functions/bash/main.sh`                             |
| Create | `src/os/macos/functions/zsh/*.sh` (copied from bash, with fixes)  |
| Create | `src/os/macos/functions/zsh/main.sh`                              |
| Create | `src/os/macos/functions/README.md`                                |

---

## Future Considerations

This plan addresses macOS only. The same pattern can be applied to other platforms:

- `src/os/ubuntu-desktop/functions/bash/` and `zsh/`
- `src/os/ubuntu-wsl/functions/bash/` and `zsh/`

Ubuntu Server typically uses bash only, so shell separation may not be needed there.
